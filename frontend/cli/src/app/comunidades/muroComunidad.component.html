<div class="perfil-container">
  <div *ngIf="comunidad.imagen && comunidad.imagen.startsWith('data:image')">
    <img [src]="comunidad.imagen" class="muro-imagen">
  </div>
  <div *ngIf="!comunidad.imagen">
    <img src="../../assets/comunidad.jpg" class="muro-imagen">
  </div>

  <h1>{{ comunidad.nombre }}</h1>

  <button *ngIf="!esCreador" class="btn btn-primary btn-block ingresar-button"
    [disabled]="!(salirValid() || !inscribirseValid())" (click)="salirValid() ? salir() : ingresar()">
    {{ salirValid() ? 'Abandonar comunidad' : (comunidad.esPrivada ? 'Solicitar ingreso' : 'Ingresar') }}
  </button>
  <button *ngIf="salirValid()" (click)="abrirModalInvitarAmigos()" class="btn btn-success btn-block">
    Invitar amigos
  </button>
  <button *ngIf="esCreador || esAdministrador" class="btn btn-primary btn-block ingresar-button"
    (click)="gestionarComunidad()">
    Gestionar
  </button>

  <div class="tabs">
    <button class="tab-button" [ngClass]="{ active: tabSeleccionada === 'publicaciones' }"
      (click)="seleccionarTab('publicaciones')">Publicaciones</button>
    <button class="tab-button" [ngClass]="{ active: tabSeleccionada === 'eventos' }"
      (click)="seleccionarTab('eventos')">Eventos</button>
    <button class="tab-button" [ngClass]="{ active: tabSeleccionada === 'miembros' }"
      (click)="seleccionarTab('miembros')">Miembros</button>
  </div>
  <div *ngIf="visible">

    <div class="tab-content">
      <div *ngIf="tabSeleccionada === 'publicaciones'" class="perfil-publicaciones">
        <h3>Publicaciones</h3>
        <button *ngIf="esParte" class="btn primary" (click)="publicarEnComunidad()">
          Publicar
        </button>

        <div class="publicaciones-grid">
          <div class="publicacion-item" *ngFor="let publicacion of publicaciones"
            (click)="esParte ? irADetallePublicacion(publicacion.id): null">
            <div class="publicacion-contenido">
              <p>{{ publicacion.texto }}</p>
              <div *ngIf="publicacion.file && publicacion.file.startsWith('data:image')">
                <img [src]="publicacion.file" alt="Imagen de la publicaciÃ³n" class="publicacion-imagen">
              </div>
              <div *ngIf="publicacion.file && publicacion.file.startsWith('data:video')">
                <video [src]="publicacion.file" controls class="publicacion-video"></video>
              </div>
              <div class="publicacion-fecha">{{ publicacion.fechaDeCreacion | date:'medium' }}</div>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="tabSeleccionada === 'eventos'" class="perfil-eventos">
        <h3 class="titulo-eventos">Eventos</h3>

        <button *ngIf="esParte" (click)="crearEvento()" class="btn btn-crear-evento">
          Crear Evento
        </button>

        <div class="eventos-grid">
          <div class="evento-item" *ngFor="let evento of eventos" (click)="irADetalleEvento(evento.id)">
            <!-- Imagen del evento como fondo -->
            <div class="evento-imagen" [style.backgroundImage]="'url(' +  (evento.imagen || '../../assets/evento.webp') + ')'"></div>

            <!-- Contenido principal (visible siempre) -->
            <div class="evento-contenido">
              <h4 class="evento-nombre">{{ evento.nombre }}</h4>
              <p class="evento-fecha">{{ evento.fechaHora | date:'medium' }}</p>
              <p>Participantes: {{ evento.participantes }} / {{ evento.cantidadMaximaParticipantes }}</p>
              <p *ngIf="evento.creador">Creador: {{ evento.creador.nombreUsuario }}</p>
            </div>

            <!-- Detalles adicionales (visibles al hacer hover) -->
            <div class="evento-detalles">
              <p class="evento-ubicacion">{{ evento.ubicacion }}</p>
              <p>Descripción: {{ evento.descripcion }}</p>
              <p *ngIf="evento.esPrivadoParaLaComunidad">Evento privado</p>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="tabSeleccionada === 'miembros'" class="perfil-miembros">
        <div *ngFor="let miembro of miembrosVisibles" class="miembro-item">
          <div>
            <img [src]="(miembro.anonimos || !miembro.fotoPerfil) ? '../../assets/usuario.png' : miembro.fotoPerfil"
              alt="{{ miembro.nombreUsuario }}" class="perfil-imagen">
            <h4>{{ miembro.nombreUsuario }}</h4>
            <span
              [ngClass]="{'creador': obtenerRol(miembro) === 'Creador', 'administrador': obtenerRol(miembro) === 'Administrador', 'miembro': obtenerRol(miembro) === 'Miembro'}"
              class="rol">
              {{ obtenerRol(miembro) }}
            </span>
          </div>
        </div>

        <!-- Mostrar la cantidad de usuarios anónimos al final con una imagen predeterminada -->
        <div *ngIf="usuariosAnonimos > 0" class="miembro-item">
          <img src="../../assets/usuario.png" alt="Usuario anónimo" class="perfil-imagen" />
          <h4>{{ usuariosAnonimos }} Usuario{{ usuariosAnonimos > 1 ? 's' : '' }} anónimo{{ usuariosAnonimos > 1 ? 's' :
            '' }}</h4>
        </div>
      </div>

    </div>
  </div>

  <div *ngIf="tabSeleccionada === 'miembros' && !visible" class="perfil-miembros">
    <h3>Creador</h3>
    <img [src]="creadorComunidad.fotoPerfil" alt="{{ creadorComunidad.nombreUsuario }}" class="perfil-imagen">
    <span>{{ creadorComunidad.nombreUsuario }}</span>
    <h3>Cantidad de miembros</h3>
    <h1>{{cantidadMiembros}}</h1>
  </div>
</div>


<ng-template #modalInvitarAmigos>
  <div class="modal-header">
    <h5 class="modal-title">Invitar amigos al evento</h5>
    <button type="button" class="close btn-close" aria-label="Close" (click)="cerrarModal()"></button>
  </div>
  <div class="modal-body">
    <!-- Amigos no en comunidad -->
    <h6 class="text-primary">Amigos que aún no están en la comunidad</h6>
    <div *ngIf="amigosNoEnComunidad.length > 0; else sinAmigosNoEnComunidad">
      <div *ngFor="let amigo of amigosNoEnComunidad"
        class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
        <span>{{ amigo.nombreUsuario }}</span>
        <button (click)="invitarAmigo(amigo.id)" class="btn btn-outline-primary btn-sm ml-2 animate-btn">
          Invitar a la comunidad
        </button>
      </div>
    </div>
    <ng-template #sinAmigosNoEnComunidad>
      <p class="text-muted">No tienes amigos disponibles para invitar.</p>
    </ng-template>

    <!-- Amigos en comunidad -->
    <h6 class="text-success mt-4">Amigos ya en la comunidad</h6>
    <div *ngIf="amigosEnComunidad.length > 0; else sinAmigosEnComunidad">
      <div *ngFor="let amigo of amigosEnComunidad"
        class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
        <span>{{ amigo.nombreUsuario }}</span>
        <span class="badge bg-success text-white">En la comunidad</span>
      </div>
    </div>
    <ng-template #sinAmigosEnComunidad>
      <p class="text-muted">No tienes amigos en la comunidad.</p>
    </ng-template>

    <!-- Amigos ya invitados -->
    <h6 class="text-warning mt-4">Amigos ya invitados</h6>
    <div *ngIf="amigosYaInvitados.length > 0; else sinAmigosYaInvitados">
      <div *ngFor="let amigo of amigosYaInvitados"
        class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
        <span>{{ amigo.nombreUsuario }}</span>
        <span class="badge bg-warning text-dark">Ya invitado</span>
      </div>
    </div>
    <ng-template #sinAmigosYaInvitados>
      <p class="text-muted">No tienes amigos ya invitados.</p>
    </ng-template>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="cerrarModal()">Cerrar</button>
  </div>
</ng-template>