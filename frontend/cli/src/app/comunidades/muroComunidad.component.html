<div class="perfil-container">
  <h1>{{ comunidad.nombre }}</h1>
  <button *ngIf="!esCreador" class="btn btn-primary btn-block ingresar-button"
    [disabled]="!(salirValid() || !inscribirseValid())" (click)="salirValid() ? salir() : ingresar()">
    {{ salirValid() ? 'Abandonar comunidad' : (comunidad.esPrivada ? 'Solicitar ingreso' : 'Ingresar') }}
  </button>


  <div class="tabs">
    <button class="tab-button" [ngClass]="{ active: tabSeleccionada === 'publicaciones' }"
      (click)="seleccionarTab('publicaciones')">Publicaciones</button>
    <button class="tab-button" [ngClass]="{ active: tabSeleccionada === 'eventos' }"
      (click)="seleccionarTab('eventos')">Eventos</button>
    <button class="tab-button" [ngClass]="{ active: tabSeleccionada === 'miembros' }"
      (click)="seleccionarTab('miembros')">Miembros</button>
  </div>

  <div class="tab-content">
    <div *ngIf="tabSeleccionada === 'publicaciones'" class="perfil-publicaciones">
      <h3>Publicaciones</h3>
      <button class="btn primary" (click)="publicarEnComunidad()">
        Publicar
      </button>

      <div class="publicaciones-grid">
        <div class="publicacion-item" *ngFor="let publicacion of publicaciones"
          (click)="irADetallePublicacion(publicacion.id)">
          <div class="publicacion-contenido">
            <p>{{ publicacion.texto }}</p>
            <div *ngIf="publicacion.file && publicacion.file.startsWith('data:image')">
              <img [src]="publicacion.file" alt="Imagen de la publicaciÃ³n" class="publicacion-imagen">
            </div>
            <div *ngIf="publicacion.file && publicacion.file.startsWith('data:video')">
              <video [src]="publicacion.file" controls class="publicacion-video"></video>
            </div>
            <div class="publicacion-fecha">{{ publicacion.fechaDeCreacion | date:'medium' }}</div>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="tabSeleccionada === 'eventos'" class="perfil-eventos">
      <h3>Eventos</h3>

      <button *ngIf="esParte" (click)="crearEvento()" class="btn btn-primary mt-3">
        Crear Evento
      </button>

    </div>

    <div *ngIf="tabSeleccionada === 'miembros'" class="perfil-miembros">
      <h3>Miembros</h3>
      <div *ngFor="let miembro of miembrosVisibles">
        <!-- Si no es anÃ³nimo, muestra el perfil -->
        <div *ngIf="!miembro.anonimos">
          <img [src]="miembro.fotoPerfil" alt="{{ miembro.nombreUsuario }}" class="perfil-imagen">
          <span>{{ miembro.nombreUsuario }}</span>
        </div>
      </div>
      <!-- Mostrar la cantidad de usuarios anÃ³nimos -->
      <div *ngIf="usuariosAnonimos > 0">
        <span>{{ usuariosAnonimos }} Usuario{{ usuariosAnonimos > 1 ? 's' : '' }} anónimo{{ usuariosAnonimos > 1
          ? 's' : '' }}</span>
      </div>
    </div>

    <button *ngIf="salirValid()" (click)="abrirModalInvitarAmigos()" class="btn btn-success btn-block mx-auto mt-3">
      Invitar amigos
    </button>

  </div>
</div>

<ng-template #modalInvitarAmigos>
  <div class="modal-header">
    <h5 class="modal-title">Invitar amigos al evento</h5>
    <button type="button" class="close btn-close" aria-label="Close" (click)="cerrarModal()"></button>
  </div>
  <div class="modal-body">
    <!-- Amigos no en comunidad -->
    <h6 class="text-primary">Amigos que aún no están en la comunidad</h6>
    <div *ngIf="amigosNoEnComunidad.length > 0; else sinAmigosNoEnComunidad">
      <div *ngFor="let amigo of amigosNoEnComunidad"
        class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
        <span>{{ amigo.nombreUsuario }}</span>
        <button (click)="invitarAmigo(amigo.id)" class="btn btn-outline-primary btn-sm ml-2 animate-btn">
          Invitar a la comunidad
        </button>
      </div>
    </div>
    <ng-template #sinAmigosNoEnComunidad>
      <p class="text-muted">No tienes amigos disponibles para invitar.</p>
    </ng-template>

    <!-- Amigos en comunidad -->
    <h6 class="text-success mt-4">Amigos ya en la comunidad</h6>
    <div *ngIf="amigosEnComunidad.length > 0; else sinAmigosEnComunidad">
      <div *ngFor="let amigo of amigosEnComunidad"
        class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
        <span>{{ amigo.nombreUsuario }}</span>
        <span class="badge bg-success text-white">En la comunidad</span>
      </div>
    </div>
    <ng-template #sinAmigosEnComunidad>
      <p class="text-muted">No tienes amigos en la comunidad.</p>
    </ng-template>

    <!-- Amigos ya invitados -->
    <h6 class="text-warning mt-4">Amigos ya invitados</h6>
    <div *ngIf="amigosYaInvitados.length > 0; else sinAmigosYaInvitados">
      <div *ngFor="let amigo of amigosYaInvitados"
        class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
        <span>{{ amigo.nombreUsuario }}</span>
        <span class="badge bg-warning text-dark">Ya invitado</span>
      </div>
    </div>
    <ng-template #sinAmigosYaInvitados>
      <p class="text-muted">No tienes amigos ya invitados.</p>
    </ng-template>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="cerrarModal()">Cerrar</button>
  </div>
</ng-template>